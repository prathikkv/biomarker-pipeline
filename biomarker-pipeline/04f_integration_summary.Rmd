---
title: "CAMK2D Integration Summary"
subtitle: "Final Module - Comprehensive Results Integration"
author: "CAMK2D Research Automation System"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    theme: flatly
    highlight: tango
    code_folding: show
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 12,
  fig.height = 8,
  fig.align = 'center',
  cache = FALSE,
  comment = "#>"
)

set.seed(42)
```

# CAMK2D Analysis Integration Summary

This final module integrates all analysis results and provides comprehensive conclusions for the CAMK2D research pipeline.

## Setup and Result Loading

```{r setup-integration}
rm(list = ls())
gc(verbose = FALSE)

suppressPackageStartupMessages({
  library(tidyverse)
  library(kableExtra)
  library(DT)
})

cat("=== CAMK2D Analysis Integration Summary ===\n")
cat("Loading all analysis results...\n")
```

## Comprehensive Results Loading

```{r load-all-results}
cat("=== Loading Analysis Results ===\n")

analysis_results <- list()
analysis_status <- data.frame(
  Module = character(),
  Status = character(),
  Key_Findings = character(),
  stringsAsFactors = FALSE
)

# Core Meta-analysis
if (file.exists("results/core_meta_analysis.rds")) {
  analysis_results$meta <- readRDS("results/core_meta_analysis.rds")
  analysis_status <- rbind(analysis_status, data.frame(
    Module = "Core Meta-Analysis",
    Status = "✅ Completed",
    Key_Findings = paste("Studies:", nrow(analysis_results$meta$data), 
                        "| Effect:", round(as.numeric(analysis_results$meta$random_model$beta), 3))
  ))
  cat("✅ Core meta-analysis results loaded\n")
} else {
  analysis_status <- rbind(analysis_status, data.frame(
    Module = "Core Meta-Analysis",
    Status = "❌ Missing",
    Key_Findings = "Results file not found"
  ))
  cat("❌ Core meta-analysis results not found\n")
}

# Publication Bias
if (file.exists("results/publication_bias_analysis.rds")) {
  analysis_results$bias <- readRDS("results/publication_bias_analysis.rds")
  bias_risk <- analysis_results$bias$tests$overall_assessment
  analysis_status <- rbind(analysis_status, data.frame(
    Module = "Publication Bias",
    Status = "✅ Completed",
    Key_Findings = paste("Risk Level:", bias_risk)
  ))
  cat("✅ Publication bias results loaded\n")
} else {
  analysis_status <- rbind(analysis_status, data.frame(
    Module = "Publication Bias",
    Status = "❌ Missing",
    Key_Findings = "Bias assessment not completed"
  ))
  cat("❌ Publication bias results not found\n")
}

# Advanced Statistics
if (file.exists("results/advanced_statistics.rds")) {
  analysis_results$advanced <- readRDS("results/advanced_statistics.rds")
  bootstrap_status <- if(!is.null(analysis_results$advanced$bootstrap$boot_results)) "Completed" else "Skipped"
  bayesian_status <- if(!analysis_results$advanced$bayesian$skipped) "Completed" else "Skipped"
  analysis_status <- rbind(analysis_status, data.frame(
    Module = "Advanced Statistics",
    Status = "✅ Completed",
    Key_Findings = paste("Bootstrap:", bootstrap_status, "| Bayesian:", bayesian_status)
  ))
  cat("✅ Advanced statistics results loaded\n")
} else {
  analysis_status <- rbind(analysis_status, data.frame(
    Module = "Advanced Statistics",
    Status = "❌ Missing",
    Key_Findings = "Advanced methods not run"
  ))
  cat("❌ Advanced statistics results not found\n")
}

# Machine Learning
if (file.exists("results/machine_learning_analysis.rds")) {
  analysis_results$ml <- readRDS("results/machine_learning_analysis.rds")
  if (!analysis_results$ml$skipped && nrow(analysis_results$ml$performance) > 0) {
    best_accuracy <- round(max(analysis_results$ml$performance$Accuracy), 3)
    analysis_status <- rbind(analysis_status, data.frame(
      Module = "Machine Learning",
      Status = "✅ Completed",
      Key_Findings = paste("Best Accuracy:", best_accuracy)
    ))
  } else {
    analysis_status <- rbind(analysis_status, data.frame(
      Module = "Machine Learning",
      Status = "⚠️ Skipped",
      Key_Findings = "Insufficient data or missing packages"
    ))
  }
  cat("✅ Machine learning results loaded\n")
} else {
  analysis_status <- rbind(analysis_status, data.frame(
    Module = "Machine Learning",
    Status = "❌ Missing",
    Key_Findings = "ML analysis not run"
  ))
  cat("❌ Machine learning results not found\n")
}

# Advanced Visualizations
if (file.exists("results/advanced_visualizations.rds")) {
  analysis_results$viz <- readRDS("results/advanced_visualizations.rds")
  plots_created <- length(analysis_results$viz$plots_created)
  analysis_status <- rbind(analysis_status, data.frame(
    Module = "Advanced Visualizations",
    Status = "✅ Completed",
    Key_Findings = paste("Plots Created:", plots_created)
  ))
  cat("✅ Visualization results loaded\n")
} else {
  analysis_status <- rbind(analysis_status, data.frame(
    Module = "Advanced Visualizations",
    Status = "❌ Missing",
    Key_Findings = "Visualizations not generated"
  ))
  cat("❌ Visualization results not found\n")
}

# Literature and Network Data
if (file.exists("data/literature_network_data.rds")) {
  analysis_results$literature <- readRDS("data/literature_network_data.rds")
  analysis_status <- rbind(analysis_status, data.frame(
    Module = "Literature Mining",
    Status = "✅ Completed",
    Key_Findings = paste("Genes Analyzed:", nrow(analysis_results$literature))
  ))
  cat("✅ Literature mining results loaded\n")
} else {
  analysis_status <- rbind(analysis_status, data.frame(
    Module = "Literature Mining",
    Status = "❌ Missing",
    Key_Findings = "Literature data not found"
  ))
  cat("❌ Literature mining results not found\n")
}

cat("\nAnalysis Summary:", nrow(analysis_status), "modules checked\n")
gc(verbose = FALSE)
```

## Analysis Status Overview

```{r status-overview}
cat("=== Analysis Pipeline Status ===\n")

analysis_status %>%
  kable(caption = "CAMK2D Analysis Pipeline Status Overview") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  column_spec(2, color = ifelse(grepl("✅", analysis_status$Status), "green",
                       ifelse(grepl("⚠️", analysis_status$Status), "orange", "red")))

# Summary statistics
completed_modules <- sum(grepl("✅", analysis_status$Status))
total_modules <- nrow(analysis_status)
completion_rate <- round(completed_modules / total_modules * 100, 1)

cat("Pipeline Completion:", completion_rate, "%\n")
cat("Completed Modules:", completed_modules, "out of", total_modules, "\n")
```

## Integrated Meta-Analysis Results

```{r integrated-meta}
cat("=== Integrated Meta-Analysis Summary ===\n")

if (!is.null(analysis_results$meta)) {
  meta_data <- analysis_results$meta$data
  meta_model <- analysis_results$meta$random_model
  
  meta_summary <- data.frame(
    Metric = c("Number of Studies", "Total Sample Size", "Pooled Effect Size (Cohen's d)", 
              "95% CI Lower", "95% CI Upper", "p-value", "I² Heterogeneity (%)", 
              "τ² (Tau-squared)", "Q-statistic", "Q p-value"),
    Value = c(
      nrow(meta_data),
      sum(meta_data$Sample_Size, na.rm = TRUE),
      round(as.numeric(meta_model$beta), 4),
      round(as.numeric(meta_model$ci.lb), 4),
      round(as.numeric(meta_model$ci.ub), 4),
      format.pval(meta_model$pval, digits = 4),
      round(meta_model$I2, 2),
      round(meta_model$tau2, 4),
      round(meta_model$QE, 2),
      format.pval(meta_model$QEp, digits = 4)
    ),
    Interpretation = c(
      paste("Based on", nrow(meta_data), "independent studies"),
      paste("Total participants:", sum(meta_data$Sample_Size, na.rm = TRUE)),
      ifelse(meta_model$beta > 0, "Positive effect", "Negative effect"),
      "Lower bound of 95% confidence interval",
      "Upper bound of 95% confidence interval",
      ifelse(meta_model$pval < 0.05, "Statistically significant", "Not significant"),
      ifelse(meta_model$I2 > 50, "High heterogeneity", 
             ifelse(meta_model$I2 > 25, "Moderate heterogeneity", "Low heterogeneity")),
      "Between-study variance",
      "Test for heterogeneity",
      ifelse(meta_model$QEp < 0.05, "Significant heterogeneity", "Homogeneous")
    )
  )
  
  meta_summary %>%
    kable(caption = "Comprehensive Meta-Analysis Results") %>%
    kable_styling(bootstrap_options = c("striped", "hover"))
  
  # Effect size interpretation
  effect_magnitude <- case_when(
    abs(as.numeric(meta_model$beta)) < 0.2 ~ "Small effect",
    abs(as.numeric(meta_model$beta)) < 0.5 ~ "Small to medium effect", 
    abs(as.numeric(meta_model$beta)) < 0.8 ~ "Medium to large effect",
    TRUE ~ "Large effect"
  )
  
  cat("Effect Size Interpretation:", effect_magnitude, "\n")
  
} else {
  cat("Meta-analysis results not available for integration\n")
  meta_summary <- data.frame(Metric = "No data", Value = "N/A", Interpretation = "Meta-analysis not completed")
}
```

## Publication Bias Integration

```{r integrated-bias}
cat("=== Publication Bias Assessment Integration ===\n")

if (!is.null(analysis_results$bias)) {
  bias_tests <- analysis_results$bias$tests
  
  bias_summary <- data.frame(
    Test = c("Egger's Test", "Rank Correlation", "Trim & Fill", "Overall Assessment"),
    Result = c(
      paste("p =", round(bias_tests$egger_test$p_value, 4)),
      paste("p =", round(bias_tests$rank_test$p_value, 4)),
      paste(bias_tests$trim_fill$missing_studies, "studies imputed"),
      bias_tests$overall_assessment
    ),
    Interpretation = c(
      ifelse(bias_tests$egger_test$significant, "Asymmetry detected", "No asymmetry"),
      ifelse(bias_tests$rank_test$significant, "Bias suggested", "No bias detected"),
      ifelse(bias_tests$trim_fill$missing_studies > 0, "Studies may be missing", "Complete dataset"),
      bias_tests$recommendation
    )
  )
  
  bias_summary %>%
    kable(caption = "Publication Bias Assessment Summary") %>%
    kable_styling(bootstrap_options = c("striped", "hover"))
  
  cat("Publication Bias Risk Level:", bias_tests$overall_assessment, "\n")
  
} else {
  cat("Publication bias assessment not available\n")
  bias_summary <- data.frame(Test = "No data", Result = "N/A", Interpretation = "Bias analysis not completed")
}
```

## Cross-Analysis Integration

```{r cross-integration}
cat("=== Cross-Analysis Integration ===\n")

# Integrate findings across all analyses
integrated_findings <- list()

# Core findings
if (!is.null(analysis_results$meta)) {
  integrated_findings$effect_size <- as.numeric(analysis_results$meta$random_model$beta)
  integrated_findings$significance <- analysis_results$meta$random_model$pval < 0.05
  integrated_findings$heterogeneity <- analysis_results$meta$random_model$I2
}

# Bias-adjusted findings
if (!is.null(analysis_results$bias)) {
  integrated_findings$bias_risk <- analysis_results$bias$tests$overall_assessment
  integrated_findings$bias_significant <- any(
    analysis_results$bias$tests$egger_test$significant,
    analysis_results$bias$tests$rank_test$significant
  )
}

# Machine learning validation
if (!is.null(analysis_results$ml) && !analysis_results$ml$skipped) {
  if (nrow(analysis_results$ml$performance) > 0) {
    integrated_findings$ml_accuracy <- max(analysis_results$ml$performance$Accuracy)
    integrated_findings$ml_feasible <- integrated_findings$ml_accuracy > 0.6
  }
}

# Literature coverage
if (!is.null(analysis_results$literature)) {
  integrated_findings$literature_genes <- nrow(analysis_results$literature)
  integrated_findings$network_density <- mean(analysis_results$literature$degree, na.rm = TRUE)
}

# Create integrated summary
if (length(integrated_findings) > 0) {
  
  integration_summary <- data.frame(
    Domain = c("Meta-Analysis", "Publication Bias", "Predictive Modeling", "Literature Coverage"),
    Key_Finding = c(
      ifelse(!is.null(integrated_findings$effect_size), 
             paste("Effect size:", round(integrated_findings$effect_size, 3)), "Not assessed"),
      ifelse(!is.null(integrated_findings$bias_risk), 
             paste("Risk level:", integrated_findings$bias_risk), "Not assessed"),
      ifelse(!is.null(integrated_findings$ml_accuracy), 
             paste("Best accuracy:", round(integrated_findings$ml_accuracy, 3)), "Not assessed"),
      ifelse(!is.null(integrated_findings$literature_genes), 
             paste("Genes analyzed:", integrated_findings$literature_genes), "Not assessed")
    ),
    Reliability = c(
      ifelse(!is.null(integrated_findings$heterogeneity), 
             ifelse(integrated_findings$heterogeneity < 50, "High", "Moderate"), "Unknown"),
      ifelse(!is.null(integrated_findings$bias_significant), 
             ifelse(integrated_findings$bias_significant, "Caution", "Good"), "Unknown"),
      ifelse(!is.null(integrated_findings$ml_feasible), 
             ifelse(integrated_findings$ml_feasible, "Predictable", "Complex"), "Unknown"),
      ifelse(!is.null(integrated_findings$network_density), 
             ifelse(integrated_findings$network_density > 5, "Well-connected", "Sparse"), "Unknown")
    )
  )
  
  integration_summary %>%
    kable(caption = "Cross-Analysis Integration Summary") %>%
    kable_styling(bootstrap_options = c("striped", "hover")) %>%
    column_spec(3, color = ifelse(integration_summary$Reliability %in% c("High", "Good", "Predictable", "Well-connected"), 
                                 "green", ifelse(integration_summary$Reliability %in% c("Caution", "Complex"), "orange", "gray")))
  
} else {
  cat("Insufficient results for cross-analysis integration\n")
}
```

## Research Conclusions and Recommendations

```{r conclusions}
cat("=== Research Conclusions and Recommendations ===\n")

# Generate evidence-based conclusions
conclusions <- list()

if (!is.null(analysis_results$meta)) {
  effect_size <- analysis_results$meta$random_model$beta
  p_value <- analysis_results$meta$random_model$pval
  heterogeneity <- analysis_results$meta$random_model$I2
  
  conclusions$main_finding <- paste0(
    "Meta-analysis of ", nrow(analysis_results$meta$data), " studies reveals ",
    ifelse(p_value < 0.05, "a statistically significant ", "no significant "),
    ifelse(effect_size > 0, "positive", "negative"), " effect (d = ", 
    round(effect_size, 3), ", p = ", format.pval(p_value, digits = 3), ")"
  )
  
  conclusions$heterogeneity_note <- paste0(
    "Between-study heterogeneity is ", 
    ifelse(heterogeneity < 25, "low", ifelse(heterogeneity < 75, "moderate", "high")),
    " (I² = ", round(heterogeneity, 1), "%)"
  )
}

if (!is.null(analysis_results$bias)) {
  bias_level <- analysis_results$bias$tests$overall_assessment
  conclusions$bias_note <- paste0(
    "Publication bias assessment indicates ", tolower(bias_level), " risk of bias"
  )
}

# Recommendations based on findings
recommendations <- c()

if (!is.null(integrated_findings$effect_size)) {
  if (abs(integrated_findings$effect_size) > 0.5) {
    recommendations <- c(recommendations, "Consider clinical translation given substantial effect size")
  } else if (abs(integrated_findings$effect_size) > 0.2) {
    recommendations <- c(recommendations, "Effect size is meaningful but requires replication")
  }
}

if (!is.null(integrated_findings$bias_significant) && integrated_findings$bias_significant) {
  recommendations <- c(recommendations, "Additional studies needed to address publication bias concerns")
}

if (!is.null(integrated_findings$heterogeneity) && integrated_findings$heterogeneity > 75) {
  recommendations <- c(recommendations, "High heterogeneity suggests need for subgroup analysis")
}

if (length(recommendations) == 0) {
  recommendations <- c("Continue systematic data collection and analysis")
}

# Display conclusions
cat("MAIN RESEARCH CONCLUSIONS:\n")
if (length(conclusions) > 0) {
  for (i in 1:length(conclusions)) {
    cat(paste(i, ".", conclusions[[i]], "\n"))
  }
} else {
  cat("1. Analysis pipeline completed with limited interpretable results\n")
}

cat("\nRECOMMENDATIONS FOR FUTURE RESEARCH:\n")
for (i in 1:length(recommendations)) {
  cat(paste(i, ".", recommendations[i], "\n"))
}
```

## Final Data Export and Summary

```{r final-export}
cat("=== Final Results Export ===\n")

# Compile final integrated results
final_results <- list(
  pipeline_status = analysis_status,
  meta_analysis = if(!is.null(analysis_results$meta)) meta_summary else "Not completed",
  publication_bias = if(!is.null(analysis_results$bias)) bias_summary else "Not completed", 
  cross_integration = if(exists("integration_summary")) integration_summary else "Not completed",
  conclusions = if(length(conclusions) > 0) conclusions else "Limited findings",
  recommendations = recommendations,
  completion_rate = completion_rate,
  generated_timestamp = Sys.time(),
  total_modules = total_modules,
  completed_modules = completed_modules
)

# Save comprehensive results
saveRDS(final_results, "results/final_integrated_results.rds")

# Export summary table to Excel if possible
tryCatch({
  if (requireNamespace("openxlsx", quietly = TRUE)) {
    library(openxlsx)
    
    wb <- createWorkbook()
    addWorksheet(wb, "Pipeline_Status")
    addWorksheet(wb, "Meta_Analysis") 
    addWorksheet(wb, "Publication_Bias")
    if (exists("integration_summary")) addWorksheet(wb, "Integration")
    
    writeData(wb, "Pipeline_Status", analysis_status)
    if (!is.null(analysis_results$meta)) writeData(wb, "Meta_Analysis", meta_summary)
    if (!is.null(analysis_results$bias)) writeData(wb, "Publication_Bias", bias_summary)
    if (exists("integration_summary")) writeData(wb, "Integration", integration_summary)
    
    saveWorkbook(wb, "results/CAMK2D_Final_Results.xlsx", overwrite = TRUE)
    cat("✅ Results exported to Excel: results/CAMK2D_Final_Results.xlsx\n")
  }
}, error = function(e) {
  cat("Excel export not available (openxlsx package needed)\n")
})

cat("✅ Final results saved to: results/final_integrated_results.rds\n")

# Final summary
cat("\n" , rep("=", 60), "\n")
cat("CAMK2D ANALYSIS PIPELINE SUMMARY\n")
cat(rep("=", 60), "\n")
cat("Total Modules:", total_modules, "\n")
cat("Completed Modules:", completed_modules, "\n") 
cat("Success Rate:", paste0(completion_rate, "%"), "\n")
cat("Analysis Date:", format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n")
cat("Results Location: results/final_integrated_results.rds\n")
cat(rep("=", 60), "\n")

# Memory cleanup
rm(list = setdiff(ls(), "final_results"))
gc(verbose = FALSE)
cat("Integration summary module completed successfully\n")
```

---

**CAMK2D Research Pipeline Integration Complete**

*This module provides the final integration of all CAMK2D analyses, offering comprehensive conclusions and research recommendations based on multi-modal evidence synthesis.*